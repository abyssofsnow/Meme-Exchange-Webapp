<!DOCTYPE html>
<html>
	<head>

		<title>{{ user_to_display.username }}'s Profile </title>

		<link rel="stylesheet" href="/static/profile_stylesheet.css">


        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
		<script src="https://apis.google.com/js/client.js"> 

		</script>

	</head>

	<body>
        {%with tempId = user_to_display.username %}
          {% include 'topNav.html' %}
        {% endwith %}

        <div id="confirmation">
            <h3 style="margin-top:0;">Status</h3>

	        <div id="confirmation-message">
    	        Friend Request Sent!
  	        </div>
        </div>


        <div class="container text-center">    
		  <div class="row">
			<div class="col-sm-3 well">
			  <div class="well">
				{% if identity == user_to_display.username %}
                    <h4>Your Profile</h4>
                {% else %}
                    <h4 id="username">{{ user_to_display.username }}</h4>
				{% endif %}

				<img src="example_pic.jpg" class="img-circle" height="65" width="65" alt="Avatar">
			  </div>
			  <div class="well">
                {% if user_to_display.bio == '' %}
                    {% if identity == user_to_display.username %}
                        <p> Why not add a bio? </p>
                    {% else %}
					    <p>User has no bio! :(</p>
                    {% endif %}
				{% else %}
					<p>{{ user_to_display.bio }}</p>
				{% endif %}
			  </div>


            {% if identity == user_to_display.username %}
                <button id="edit_profile_button" data-toggle="modal" data-target="#editProfile">Edit Profile</button>
			{% elif identity != '' %}
                <button id="add_friend_button" >Add Friend</button>
			{% endif %}
			</div>



			<div class="col-sm-9">
			  <div class="row">
				<div class="col-sm-12">
				    <div class="panel panel-default text-left">
				        <div class="panel-body">
					        <p>Memes</p>

                            {% if memes_owned|length %}
                                {% for meme in memes_owned %}
                                    <div id="meme">
                                        <a href="/meme/{{meme.id}}">{{ meme.title }}</a> 
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p> No memes! </p>
                            {% endif %}
					    </div>
				    </div>
				</div>
			  </div>

			  <div class="row">
				<div class="col-sm-12">
				    <div class="well">
                        <p> Friends </p>

                        <div id="friends_list" class="scrollable_list">
                            {% for friend in user_to_display.friends %}
                                <div id="friend">
                                    <a href="/user/{{friend.username}}">{{ friend.username }}</a> 
                                    <img src="prof.jpg" alt="pic" class="img-circle" height="55" width="55" alt="Avatar">
                                </div>
                            {% endfor %}
			            </div>
				  </div>
				</div>
            </div>
        </div>

        <!-- Edit Profile Modal Element -->

        <div class="modal fade" id="editProfile" tabindex="-1" role="dialog" aria-labelledby="editProfile" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h3 class="modal-title" id="exampleModalLabel">Edit Your Profile</h3>
                    </div>

                    <div class="modal-body">

                        <label for="img">Upload new profile picture:</label>
                        <input type="file" id="img" name="img" accept="image/*">		
                            
                        <label for="bio_to_display">Choose your bio: </label>
                        <input id="bio_to_display" value="{{ user_to_display.bio }}"> <br>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>

                    </div>
                </div>
            </div>
        </div>



		<script>

			var identity = '{{ identity }}' //This is who I'm logged in as.
			var user = {{ safe_user_to_display|safe }}; //I'm storing the data I sent from the server into a JS variable so if I edit the profile,
												//I don't have to requery the DB.

			 
            document.getElementById ("add_friend_button").addEventListener ("click", addFriend, false);


			function createXmlHttp() {
				let xmlhttp;
			
				if (window.XMLHttpRequest)
					xmlhttp = new XMLHttpRequest();
				else
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

				if (!(xmlhttp)) 
					alert("Your browser does not support AJAX!");

				return xmlhttp;
			}

			/*

			//displays profile settings if exist, else add new profile settings
			function profileExist(username){
				var profileData = document.getElementById('bio');
				var profileForm = new FormData(profileData);

				
				//creating new request object
				let xmlhttp = new XMLHttpRequest();
				let profileURL = "/user/" + username;

	

				xmlhttp.onreadystatechange = function(){
					if (xmlhttp.readyState == 4 && (xmlhttp.status == 200)){
						console.log(xmlHttp.status);
					}else{
						console.log("Not ready");
					}

					if (xmlhttp.status === 404){return;}
					try{
						let response = JSON.parse(xmlhttp.responseText);
						document.getElementById("bio").value = response["bio"];
					}catch (err){
						console.error("Server Error");
					}

				}				

			
				//TODO: Getting data from storage bucket-----------------------------
				var parameterObj = {};	//declaring and initializing parameter object 
				parameterObj['MemeExchange'] = "";	//setting project id

				
				//Making request to Google Cloud Storage API
				var request = gapi.client.storage.buckets.list(parameterObj);

				

				//retrieving and inserting into textbox element
				document.getElementById("bio").innerHTML = google.storage;
				//let firstname = document.getElementById("first-name").value;

				

				//TODO: filling existent data into profile form html
				if(profileForm.has(name)){
					//display data if has data
				}else{
					document.getElementById("profileEdit").style.display = "inline";
				}

				//configuring request
				xmlhttp.open("POST", profileURL, [async, user.username, user.password]);
				//sending request over network
				xmlhttp.send(profileForm);				
			}

			*/


			function addFriend() {
				//Set up xmlhttprequest object.
				var request = createXmlHttp();

				request.onreadystatechange = function() {
 					if (request.readyState == 4) {

                        document.getElementById("username").innerHTML = "RESPONSE RECEIVED"
                        if(request.status === 500)
                            document.getElementById("username").innerHTML = "500"
                            
		                 switch(request.status) {

		                    case 200: //Success
		                        document.getElementById("confirmation-message").innerHTML = "Friend request sent!";
		                        break;

		                    case 500: //Server failed to send request.
		                        document.getElementById("confirmation-message").innerHTML = "A server error occurred.";
                                document.getElementById("username").innerHTML = "Server Error"
		                        break;

		                    case 401: //These users are already friends
		                        document.getElementById("confirmation-message").innerHTML = "You two are already friends!";
		                        break;

		                    case 400: //This user already sent a request.
		                        document.getElementById("confirmation-message").innerHTML = "Be patient! You've already sent a request.";
		                        break;

		                    case 403: //This user already received a request.
		                        document.getElementById("confirmation-message").innerHTML = "Check your notifications!"
		                        break;
		                 }

						document.getElementById("confirmation").style.visibility = "visible";

		                 setTimeout( function() {
		                    document.getElementById("confirmation").style.visibility = "hidden";
		                 }, 3000)
 					}

 				}

                 var sentReceived = {
                    sender: identity,
                    receiver: user.username
                 };

				request.open("POST", "/sendFriendRequest", true);
				request.setRequestHeader("Content-type", "application/json")
				request.send(JSON.stringify(sentReceived));
			}

		</script>

	</body>

</html>

