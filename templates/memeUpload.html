<html>
	<head>
		<meta charset="utf-8" />
		<title>Meme Upload</title>	
	</head>

	<body>
		{% if user_to_display is defined %}
            {%with tempId = user_to_display.username, identity = identity, user_to_display = user_to_display %}
            {% include 'topNav.html' %}
            {% endwith %}
        {% else %}
            {% include 'topNav.html' %}
        {% endif %}
		
		<h1><font face="Papyrus">Lets Begin Memeing</font></h1>
		<br/>
		<section align="left">
			<input type="file" id="meme" name="fileUpload" accept="image/*"/>
			<input type="text" id="memeTitle" placeholder="Title Your Meme">
			<button onclick="saveMeme()" id="submit">Submit</button>
		</section>
	</body>
	
	
	<script>
			

		var memeID; //This will be the id that datastore gives to the meme, so we can navigate to it when it's uploaded.
		
		function saveMeme(){
			// Get title and picture of meme.
			var memeTitle = document.getElementById('memeTitle').value;
			var picture = document.getElementById('meme').files[0];

			//Create the JSON version.
            var jsonMemeInfo = JSON.stringify({"title": memeTitle, "filename": picture.name, "contentType": picture.type});
			
			//Send POST request to save the meme in data store.
            var request = createXmlHttp();
            request.responseType = "json";
            request.open("PUT", "/meme/save-meme", true)
            request.onload = () => { 
                if (request.status === 200) {
                    var jsonResponse = request.response;
					this.memeID = jsonResponse["meme_id"];
                    this.document.getElementById("memeTitle").innerHTML = this.memeID;
                    var signedUrl = jsonResponse["signedUrl"];
                    uploadFileToCloudStorage(signedUrl, picture)
                } else {
                    alert("Error encountered when uploading to data store");
                }
            };
            request.onerror = () => {
                alert("Something went wrong");
            };

			request.setRequestHeader("Content-Type", "application/json");
            console.log(jsonMemeInfo);
            request.send(jsonMemeInfo);
		}		
	
		
		function uploadFileToCloudStorage(signedUrl, picture) {

			var result = ""
			const request = createXmlHttp();
			request.open("PUT", signedUrl, true);
			request.onload = () => {
				if (request.status === 200) {
					this.window.location.href = "/meme/" + this.memeID;
				} else {
					alert("Something went wrong!");
				}
			};
			request.onerror = () => {
				alert("Something went wrong");
			};
			request.setRequestHeader('Content-Type', picture.type);
			request.send(picture);
		}
		function createXmlHttp() {
				let xmlhttp;
			
				if (window.XMLHttpRequest)
					xmlhttp = new XMLHttpRequest();
				else
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

				if (!(xmlhttp)) 
					alert("Your browser does not support AJAX!");

				return xmlhttp;
			}
		
		
			
	</script>	
</html>	

